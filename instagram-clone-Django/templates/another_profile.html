{% extends "base.html" %}
{% load static %}
{% load my_tags %}

{% block title %}{{ user.username }}'s Profile • Instagram{% endblock %}


{% block home_active %}active{% endblock %}


{% block extra_css %}
<style>
    /* Overlay */
    .edit-profile-modal {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .edit-profile-content {
        background: #111;
        padding: 30px;
        border-radius: 12px;
        border: 1px solid #262626;
        width: 90%;
        max-width: 420px;
        color: #fff;
        box-shadow: 0 8px 30px rgba(0,0,0,0.8);

        transform: scale(0.8);
        opacity: 0;
        animation: popUp 0.3s ease forwards;
    }


    @keyframes popUp {
        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .edit-profile-content h2 {
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: 600;
        color: #fff;
        text-align: center;
    }

    .edit-profile-form p {
        margin-bottom: 15px;
    }

    .edit-profile-form input,
    .edit-profile-form select,
    .edit-profile-form textarea {
        width: 100%;
        padding: 10px;
        background: #121212;
        border: 1px solid #262626;
        border-radius: 6px;
        color: #fff;
        font-size: 14px;
    }

    .edit-profile-form input:focus,
    .edit-profile-form select:focus,
    .edit-profile-form textarea:focus {
        border-color: #0095f6;
        outline: none;
    }

    .save-btn {
        width: 100%;
        margin-top: 10px;
        background-color: #0095f6;
        border-color: #0095f6;
    }

    .save-btn:hover {
        background-color: #1877f2;
    }

    /* Close button */
    .close-btn {
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #bbb;
    }

    .close-btn:hover {
        color: #fff;
    }

    /* Animation */
    @keyframes fadeIn {
        from {opacity: 0; transform: translateY(-20px);}
        to {opacity: 1; transform: translateY(0);}
    }

        .profile-page {
            max-width: 975px;
            margin: 0 auto;
            padding: 30px 20px;
            color: #fff;
        }

        /* Profile Header */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 80px;
            margin-bottom: 44px;
            padding-bottom: 44px;
            border-bottom: 1px solid #262626;
        }

        .profile-avatar-large {
            flex-shrink: 0;
        }

        .profile-avatar-large img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #262626;
        }

        .profile-info {
            flex: 1;
        }

        .profile-info h1 {
            font-size: 28px;
            font-weight: 300;
            margin-bottom: 20px;
            color: #fff;
        }

        .profile-stats {
            display: flex;
            gap: 40px;
            margin-bottom: 20px;
        }

        .profile-stat {
            font-size: 16px;
            color: #fff;
            text-decoration: none;
        }

        .profile-stat strong {
            font-weight: 600;
        }

        .profile-bio {
            margin-bottom: 20px;
        }

        .profile-bio strong {
            display: block;
            margin-bottom: 4px;
            color: #fff;
        }

        .profile-bio p {
            color: #fff;
            line-height: 1.4;
        }

        /* Profile Actions */
        .profile-actions {
            display: flex;
            gap: 8px;
        }

        .profile-btn {
            background-color: #262626;
            border: 1px solid #262626;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .profile-btn:hover {
            background-color: #363636;
            border-color: #363636;
        }

        .follow-btn {
            background-color: #0095f6;
            border-color: #0095f6;
        }

        .follow-btn:hover {
            background-color: #1877f2;
            border-color: #1877f2;
        }

        .following-btn {
            background-color: #262626;
            border-color: #262626;
            color: #fff;
        }

        /* Profile Navigation */
        .profile-nav {
            border-top: 1px solid #262626;
            margin-bottom: 28px;
        }

        .profile-nav-tabs {
            display: flex;
            justify-content: center;
            gap: 60px;
            padding: 16px 0;
        }

        .profile-tab {
            background: none;
            border: none;
            color: #8e8e8e;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 16px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
            border-top: 1px solid transparent;
        }

        .profile-tab.active {
            color: #fff;
            border-top-color: #fff;
        }

        .profile-tab:hover {
            color: #fff;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Profile Grid */
        .profile-posts, .profile-reels, .tagged-posts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            padding: 0;
        }

        .profile-item {
            position: relative;
            cursor: pointer;
            overflow: hidden;
            background-color: #262626;
            transition: transform 0.1s ease;
            aspect-ratio: 1;
        }

        .profile-item:hover {
            transform: scale(1.02);
            z-index: 10;
        }

        .profile-item img,
        .profile-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: filter 0.2s ease;
        }

        .profile-item:hover img,
        .profile-item:hover video {
            filter: brightness(0.8);
        }

        /* Overlay that appears on hover */
        .profile-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .profile-item:hover .profile-overlay {
            opacity: 1;
        }

        .profile-stats-overlay {
            display: flex;
            align-items: center;
            gap: 20px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
        }

        .profile-stat-overlay {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Content type indicators */
        .content-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 5;
        }

        .reel-indicator {
            width: 24px;
            height: 24px;
            color: #fff;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.8));
        }

        /* Modal Styles */
        .post-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .post-modal.active {
            display: flex;
        }

        .modal-content {
            background: #000;
            border-radius: 8px;
            max-width: 1200px;
            max-height: 90vh;
            width: 90%;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .modal-media {
            flex: 1;
            max-width: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        .modal-media img,
        .modal-media video {
            width: 100%;
            height: auto;
            max-height: 90vh;
            object-fit: contain;
        }

        .modal-sidebar {
            width: 400px;
            background: #000;
            border-left: 1px solid #262626;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #262626;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-user-info {
            display: flex;
            align-items: center;
        }

        .modal-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            overflow: hidden;
        }

        .modal-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-username {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-right: 12px;
            text-decoration: none;
        }

        .modal-follow-btn {
            background: none;
            border: 1px solid #0095f6;
            color: #0095f6;
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .modal-follow-btn:hover {
            background-color: #0095f6;
            color: #fff;
        }

        .modal-follow-btn.following {
            background-color: #262626;
            border-color: #262626;
            color: #fff;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .modal-post-info {
            padding: 16px;
            border-bottom: 1px solid #262626;
        }

        .modal-caption {
            color: #fff;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 16px;
        }

        .modal-caption .caption-username {
            font-weight: 600;
            margin-right: 8px;
        }

        .modal-stats {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .modal-time {
            color: #8e8e8e;
            font-size: 12px;
            margin-bottom: 0;
        }

        .modal-comments {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            max-height: 300px;
        }

        .comment-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 12px;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
        }

        .comment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .comment-content {
            flex: 1;
        }

        .comment-text {
            font-size: 14px;
            color: #fff;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .comment-text .comment-username {
            font-weight: 600;
            margin-right: 8px;
        }

        .comment-actions {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 12px;
            color: #8e8e8e;
        }

        .comment-time {
            font-weight: 400;
        }

        .comment-reply {
            cursor: pointer;
            font-weight: 600;
            background: none;
            border: none;
            color: #8e8e8e;
            padding: 0;
        }

        .comment-reply:hover {
            color: #fff;
        }

        .comment-likes {
            font-weight: 600;
        }

        .comment-heart {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-left: auto;
            color: #8e8e8e;
        }

        .comment-heart:hover {
            color: #fff;
        }

        .comment-heart.liked {
            color: #ed4956;
        }

        .replies-container {
            display: block;

            margin-left: 44px;
            margin-top: 8px;
        }

        .reply-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 8px;
        }

        .reply-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 10px;
            font-weight: 600;
        }

        .reply-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-actions {
            padding: 16px;
            border-top: 1px solid #262626;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-actions-left {
            display: flex;
            gap: 16px;
        }

        .modal-action-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            font-size: 24px;
        }

        .modal-action-btn:hover {
            background-color: #1a1a1a;
        }

        .modal-action-btn.liked {
            color: #ed4956;
        }

        .modal-action-btn.saved {
            color: #fff;
        }

        /* Comment Input Section */
        .comment-input-section {
            padding: 16px;
            border-top: 1px solid #262626;
            background: #000;
        }

        .comment-form {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .comment-input {
            flex: 1;
            background: none;
            border: none;
            color: #fff;
            font-size: 14px;
            outline: none;
            padding: 8px 0;
        }

        .comment-input::placeholder {
            color: #8e8e8e;
        }

        .comment-submit-btn {
            background: none;
            border: none;
            color: #0095f6;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 0;
            opacity: 0.3;
            transition: opacity 0.2s ease;
        }

        .comment-submit-btn.active {
            opacity: 1;
        }

        .comment-submit-btn:hover.active {
            color: #1877f2;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #8e8e8e;
            grid-column: 1 / -1;
        }

        .empty-state i {
            font-size: 96px;
            margin-bottom: 24px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 22px;
            margin-bottom: 8px;
            color: #fff;
        }

        .no-comments {
            text-align: center;
            padding: 20px;
            color: #8e8e8e;
            font-size: 14px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .profile-header {
                gap: 30px;
                flex-direction: column;
                text-align: center;
            }

            .profile-nav-tabs {
                gap: 40px;
            }

            .profile-posts, .profile-reels, .tagged-posts {
                grid-template-columns: repeat(2, 1fr);
                gap: 2px;
            }

            .modal-content {
                flex-direction: column;
                width: 95%;
                max-height: 95vh;
            }

            .modal-sidebar {
                width: 100%;
                max-height: 60vh;
            }

            .modal-media {
                max-width: 100%;
            }

            .modal-comments {
                max-height: 200px;
            }
        }
</style>
{% endblock %}

{% block content %}
<div class="profile-page">
    <div class="profile-header">
        <div class="profile-avatar-large">
            {% if user.avatar %}
            <img src="{{ user.avatar.url }}" alt="{{ user.username }}">
            {% else %}
            <img src="{% static 'images/default-avatar.png' %}" alt="{{ user.username }}">
            {% endif %}
        </div>

        <div class="profile-info">
            <h1>{{ user.username }}</h1>
            <div class="profile-stats">
                <div class="profile-stat"><strong>{{ posts.count|add:reels.count }}</strong> posts</div>
                <a href="{% url 'followers' user.pk %}" class="profile-stat"><strong>{{ user.followers_count }}</strong>
                    followers</a>
                <a href="{% url 'followings' user.pk %}" class="profile-stat">
                    <strong>{{ user.following_count }}</strong> following
                </a>
            </div>
            <div class="profile-bio">
                {% if user.first_name or user.last_name %}
                <strong>{{ user.first_name }} {{ user.last_name }}</strong>
                {% endif %}
                {% if user.bio %}
                <p>{{ user.bio|linebreaks }}</p>
                {% endif %}
                {% if user.website %}
                <a href="{{ user.website }}" target="_blank" class="profile-btn">{{ user.website }}</a>
                {% endif %}
            </div>
             <div class="profile-actions">
                <button class="profile-btn" id="follow-btn" data-user-id="{{ user.id }}">
                    <a style="color:white;text-decoration:none;" href="{% url 'follow-create' pk=user.id %}">
                        {% if request|is_following:user %}
                        Unfollow
                        {% else %}
                        Follow
                        {% endif %}
                    </a>
                </button>
                <a style="text-decoration:none;" href="{% url 'profile-another-chat' username=user.username %}" class="profile-btn">Message</a>
            </div>
        </div>
    </div>
    <div class="profile-nav">
        <div class="profile-nav-tabs">
            <button class="profile-tab active" data-tab="posts">
                <i class="fas fa-th"></i>
                Posts
            </button>
            <button class="profile-tab" data-tab="reels">
                <i class="fas fa-play-circle"></i>
                Reels
            </button>
            <button class="profile-tab" data-tab="tagged">
                <i class="fas fa-user-tag"></i>
                Tagged
            </button>
        </div>
    </div>

    <div class="tab-content active" id="posts-content">
        <div class="profile-posts">
            {% if posts %}
            {% for post in posts %}
            <div class="profile-item"
                 data-type="post"
                 data-id="{{ post.id }}"
                 data-url="{{ post.contentUrl.url }}"
                 data-username="{{ post.userID.username }}"
                 data-user-avatar="{% if post.userID.avatar %}{{ post.userID.avatar.url }}{% endif %}"
                 data-caption="{{ post.caption }}"
                 data-likes="{{ post.likes_count }}"
                 data-comments="{{ post.comments_count }}"
                 data-liked-by-user="{% if post|is_liked_by_user:request %}true{% else %}false{% endif %}"
                 data-saved-by-user="{% if request.user in post.saved.all %}true{% else %}false{% endif %}"
                 data-user-id="{{ post.userID.id }}"
                 data-is-followed="{% if request|is_following:post.userID %}true{% else %}false{% endif %}"
                 data-is-self="{% if post.userID == request.user %}true{% else %}false{% endif %}">

                {% if post.contentUrl %}
                <img src="{{ post.contentUrl.url }}" alt="Post" loading="lazy">
                {% endif %}

                <div class="profile-overlay">
                    <div class="profile-stats-overlay">
                        <div class="profile-stat-overlay">
                            <i class="fas fa-heart"></i>
                            <span>{{ post.likes_count }}</span>
                        </div>
                        <div class="profile-stat-overlay">
                            <i class="fas fa-comment"></i>
                            <span>{{ post.comments_count }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="empty-state">
                <i class="fas fa-camera"></i>
                <h3>No posts yet</h3>
                <p>When you share photos, they'll appear on your profile.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="tab-content" id="reels-content">
        <div class="profile-reels">
            {% if reels %}
            {% for reel in reels %}
            <div class="profile-item reel"
                 data-type="reel"
                 data-id="{{ reel.id }}"
                 data-url="{{ reel.contentUrl.url }}"
                 data-username="{{ reel.userID.username }}"
                 data-user-avatar="{% if reel.userID.avatar %}{{ reel.userID.avatar.url }}{% endif %}"
                 data-caption="{{ reel.caption }}"
                 data-likes="{{ reel.likes_count }}"
                 data-views="{{ reel.likes_count }}"
                 data-liked-by-user="{% if reel|is_liked_by_user:request %}true{% else %}false{% endif %}"
                 data-saved-by-user="{% if request.user in reel.saved.all %}true{% else %}false{% endif %}"
                 data-user-id="{{ reel.userID.id }}"
                 data-is-followed="{% if request|is_following:reel.userID %}true{% else %}false{% endif %}"
                 data-is-self="{% if reel.userID == request.user %}true{% else %}false{% endif %}">

                {% if reel.contentUrl %}
                <video muted loop playsinline preload="metadata">
                    <source src="{{ reel.contentUrl.url }}" type="video/mp4">
                </video>
                {% endif %}

                <div class="content-indicator">
                    <i class="fas fa-play reel-indicator"></i>
                </div>
                <div class="profile-overlay">
                    <div class="profile-stats-overlay">
                        <div class="profile-stat-overlay">
                            <i class="fas fa-heart"></i>
                            <span>{{ reel.likes_count }}</span>
                        </div>
                        <div class="profile-stat-overlay">
                            <i class="fas fa-eye"></i>
                            <span>{{ reel.likes_count }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="empty-state">
                <i class="fas fa-video"></i>
                <h3>No reels yet</h3>
                <p>When you share reels, they'll appear on your profile.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="tab-content" id="tagged-content">
        <div class="tagged-posts">
            <div class="empty-state">
                <i class="fas fa-user-tag"></i>
                <h3>No tagged posts yet</h3>
                <p>When people tag you in photos, they'll appear here.</p>
            </div>
        </div>
    </div>
</div>

<div class="post-modal" id="postModal">
    <button class="modal-close" onclick="closeModal()">
        <i class="fas fa-times"></i>
    </button>

    <div class="modal-content">
        <div class="modal-media">
            <img id="modalImage" src="/placeholder.svg" alt="" style="display: none;">
            <video id="modalVideo" controls muted loop playsinline style="display: none;">
                <source src="/placeholder.svg" type="video/mp4">
            </video>
        </div>

        <div class="modal-sidebar">
            <div class="modal-header">
                <div class="modal-user-info">
                    <div class="modal-avatar" id="modalAvatar">U</div>
                    <a href="#" class="modal-username" id="modalUsername">username</a>
                    <a href="#" class="modal-follow-btn" id="modalFollowBtn" style="display: none;">Follow</a>
                </div>
            </div>

            <div class="modal-body">
                <div class="modal-post-info">
                    <div class="modal-caption" id="modalCaption"></div>
                    <div class="modal-stats" id="modalStats"></div>
                    <div class="modal-time" id="modalTime">2 hours ago</div>
                </div>

                <div class="modal-comments" id="modalComments">
                    Comments will be loaded here dynamically
                </div>
            </div>

            <div class="modal-actions">
                <div class="modal-actions-left">
                    <button class="modal-action-btn" id="modalLikeBtn" onclick="toggleModalLike()">
                        <i class="far fa-heart"></i>
                    </button>
                    <button class="modal-action-btn" onclick="focusCommentInput()">
                        <i class="far fa-comment"></i>
                    </button>
                    <button class="modal-action-btn">
                        <i class="far fa-paper-plane"></i>
                    </button>
                </div>
                <button class="modal-action-btn" id="modalSaveBtn" onclick="toggleModalSave()">
                    <i class="far fa-bookmark"></i>
                </button>
            </div>

            <div class="comment-input-section">
                <form class="comment-form" method="post" id="commentForm">
                    {% csrf_token %}
                    <input type="hidden" name="post_id" id="modalPostId" value="">
                    <input type="hidden" name="parent_comment_id" id="parentCommentId" value="">
                    <input
                            type="text"
                            class="comment-input"
                            name="comment"
                            placeholder="Add a comment..."
                            id="commentInput"
                            maxlength="250"
                    >
                    <input
                            type="text"
                            class="comment-input"
                            name="reply_comment"
                            placeholder="Add a reply..."
                            id="replyInput"
                            maxlength="250"
                            style="display: none;"
                    >
                    <button type="submit" class="comment-submit-btn" id="commentSubmitBtn">Post</button>
                    <button type="button" class="comment-submit-btn" id="cancelReplyBtn" style="display: none;"
                            onclick="cancelReply()">Cancel
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPostData = null;
    let isReplyMode = false;
    let postsData = {};

    // Initialize posts data function
    function initializePostsData() {
        {% for post in posts %}
        postsData['{{ post.id }}'] = {
            comments: [
                {% for comment in post.comments.all %}
                {
                    id: {{ comment.id }},
                    username: '{{ comment.userID.username }}',
                    userAvatar: '{% if comment.userID.avatar %}{{ comment.userID.avatar.url }}{% endif %}',
                    text: '{{ comment.comment|escapejs }}',
                    timeAgo: '{{ comment.since_created }}',
                    likesCount: {{ comment.comment_likes_count }},
                    likedByUser: {% if comment|is_comment_liked_by_user:request.user %}true{% else %}false{% endif %},
                    replies: [
                        {% for reply in comment.reply_comments.all %}
                        {
                            id: {{ reply.id }},
                            username: '{{ reply.userID.username }}',
                            userAvatar: '{% if reply.userID.avatar %}{{ reply.userID.avatar.url }}{% endif %}',
                            text: '{{ reply.reply_comment|escapejs }}',
                            timeAgo: '{{ reply.since_created }}',
                            likesCount: {{ reply.reply_comment_likes_count }},
                            likedByUser: {% if reply|is_reply_liked_by_user:request.user %}true{% else %}false{% endif %}
                        }{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ]
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        };
        {% endfor %}

        {% for reel in reels %}
        postsData['{{ reel.id }}'] = {
            comments: [
                {% for comment in reel.comments.all %}
                {
                    id: {{ comment.id }},
                    username: '{{ comment.userID.username }}',
                    userAvatar: '{% if comment.userID.avatar %}{{ comment.userID.avatar.url }}{% endif %}',
                    text: '{{ comment.comment|escapejs }}',
                    timeAgo: '{{ comment.since_created }}',
                    likesCount: {{ comment.comment_likes_count }},
                    likedByUser: {% if comment|is_comment_liked_by_user:request.user %}true{% else %}false{% endif %},
                    replies: [
                        {% for reply in comment.reply_comments.all %}
                        {
                            id: {{ reply.id }},
                            username: '{{ reply.userID.username }}',
                            userAvatar: '{% if reply.userID.avatar %}{{ reply.userID.avatar.url }}{% endif %}',
                            text: '{{ reply.reply_comment|escapejs }}',
                            timeAgo: '{{ reply.since_created }}',
                            likesCount: {{ reply.reply_comment_likes_count }},
                            likedByUser: {% if reply|is_reply_liked_by_user:request.user %}true{% else %}false{% endif %}
                        }{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ]
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        };
        {% endfor %}
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize posts data first
        initializePostsData();

        // Tab switching functionality
        const tabs = document.querySelectorAll('.profile-tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.getAttribute('data-tab');
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(targetTab + '-content').classList.add('active');
            });
        });

        // Video hover functionality for reels
        const reelItems = document.querySelectorAll('.profile-item.reel');
        reelItems.forEach(item => {
            const video = item.querySelector('video');
            if (video) {
                item.addEventListener('mouseenter', function() {
                    video.play().catch(() => {});
                });
                item.addEventListener('mouseleave', function() {
                    video.pause();
                    video.currentTime = 0;
                });
            }
        });

        // Click handlers for opening modal
        const profileItems = document.querySelectorAll('.profile-item');
        profileItems.forEach(item => {
            item.addEventListener('click', function() {
                openModal(this);
            });
        });

        // Comment form submission
        const commentForm = document.getElementById('commentForm');
        if (commentForm) {
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitComment();
            });
        }

        // Comment input functionality
        const commentInput = document.getElementById('commentInput');
        const replyInput = document.getElementById('replyInput');
        const commentSubmitBtn = document.getElementById('commentSubmitBtn');

        if (commentInput && commentSubmitBtn) {
            commentInput.addEventListener('input', function() {
                updateSubmitButton();
            });
        }

        if (replyInput && commentSubmitBtn) {
            replyInput.addEventListener('input', function() {
                updateSubmitButton();
            });
        }
    });

    function loadComments(postId) {
        const modalComments = document.getElementById('modalComments');

        // Get comments from our initialized data
        const postData = postsData[postId];
        if (!postData || !postData.comments) {
            modalComments.innerHTML = '<div class="no-comments">No comments yet.</div>';
            return;
        }

        renderComments(postData.comments);
    }

    function renderComments(comments) {
        const modalComments = document.getElementById('modalComments');

        if (comments.length === 0) {
            modalComments.innerHTML = '<div class="no-comments">No comments yet.</div>';
            return;
        }

        modalComments.innerHTML = '';

        comments.forEach(comment => {
            const commentElement = createCommentElement(comment);
            modalComments.appendChild(commentElement);
        });
    }

    function createCommentElement(comment) {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment-item';
        commentDiv.dataset.commentId = comment.id;

        const avatarHtml = comment.userAvatar ?
            `<img src="${comment.userAvatar}" alt="${comment.username}">` :
            comment.username.charAt(0).toUpperCase();

        commentDiv.innerHTML = `
            <div class="comment-avatar">${avatarHtml}</div>
            <div class="comment-content">
                <div class="comment-text">
                    <span class="comment-username">${comment.username}</span>${comment.text}
                </div>
                <div class="comment-actions">
                    <span class="comment-time">${comment.timeAgo}</span>
                    <button class="comment-reply" onclick="startReply('${comment.id}', '${comment.username}')">Reply</button>
                    <span class="comment-likes">${comment.likesCount} likes</span>
                    <button class="comment-heart ${comment.likedByUser ? 'liked' : ''}" onclick="toggleCommentLike(${comment.id})">
                        <i class="fas fa-heart"></i>
                    </button>
                </div>
                <div class="replies-container" id="replies-${comment.id}">
                    ${comment.replies ? comment.replies.map(reply => createReplyHTML(reply)).join('') : ''}
                </div>
            </div>
        `;

        return commentDiv;
    }

    function createReplyHTML(reply) {
        const avatarHtml = reply.userAvatar ?
            `<img src="${reply.userAvatar}" alt="${reply.username}">` :
            reply.username.charAt(0).toUpperCase();

        return `
            <div class="reply-item" data-reply-id="${reply.id}">
                <div class="reply-avatar">${avatarHtml}</div>
                <div class="comment-content">
                    <div class="comment-text">
                        <span class="comment-username">${reply.username}</span>${reply.text}
                    </div>
                    <div class="comment-actions">
                        <span class="comment-time">${reply.timeAgo}</span>
                        <span class="comment-likes">${reply.likesCount} likes</span>
                        <button class="comment-heart ${reply.likedByUser ? 'liked' : ''}" onclick="toggleReplyLike(${reply.id})">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function updateSubmitButton() {
        const commentInput = document.getElementById('commentInput');
        const replyInput = document.getElementById('replyInput');
        const commentSubmitBtn = document.getElementById('commentSubmitBtn');

        const activeInput = isReplyMode ? replyInput : commentInput;

        if (activeInput && activeInput.value.trim().length > 0) {
            commentSubmitBtn.classList.add('active');
        } else {
            commentSubmitBtn.classList.remove('active');
        }
    }

    function openModal(item) {
        const modal = document.getElementById('postModal');
        const modalImage = document.getElementById('modalImage');
        const modalVideo = document.getElementById('modalVideo');
        const modalUsername = document.getElementById('modalUsername');
        const modalAvatar = document.getElementById('modalAvatar');
        const modalCaption = document.getElementById('modalCaption');
        const modalStats = document.getElementById('modalStats');
        const modalLikeBtn = document.getElementById('modalLikeBtn');
        const modalSaveBtn = document.getElementById('modalSaveBtn');
        const modalFollowBtn = document.getElementById('modalFollowBtn');
        const modalPostId = document.getElementById('modalPostId');
        const modalTime = document.getElementById('modalTime');

        // Store current post data
        currentPostData = {
            type: item.dataset.type,
            id: item.dataset.id,
            url: item.dataset.url,
            username: item.dataset.username,
            userAvatar: item.dataset.userAvatar,
            caption: item.dataset.caption,
            likes: parseInt(item.dataset.likes),
            comments: parseInt(item.dataset.comments),
            views: item.dataset.views,
            likedByUser: item.dataset.likedByUser === 'true',
            savedByUser: item.dataset.savedByUser === 'true',
            isSelf: item.dataset.isSelf === 'true',
            isFollowed: item.dataset.isFollowed === 'true',
            userId: item.dataset.userId
        };

        // Set media
        modalImage.style.display = 'none';
        modalVideo.style.display = 'none';
        modalVideo.pause();

        if (currentPostData.type === 'post') {
            modalImage.src = currentPostData.url;
            modalImage.style.display = 'block';
        } else if (currentPostData.type === 'reel') {
            modalVideo.src = currentPostData.url;
            modalVideo.style.display = 'block';
            modalVideo.load();
        }

        // Set user info
        modalUsername.textContent = currentPostData.username;
        modalUsername.href = `/another_profile/${currentPostData.userId}/`;

        if (currentPostData.userAvatar) {
            modalAvatar.innerHTML = `<img src="${currentPostData.userAvatar}" alt="${currentPostData.username}">`;
        } else {
            modalAvatar.textContent = currentPostData.username.charAt(0).toUpperCase();
        }

        // Set caption
        modalCaption.innerHTML = `<span class="caption-username">${currentPostData.username}</span>${currentPostData.caption}`;

        // Set stats
        updateModalStats();

        // Set like state
        updateLikeButton();

        // Set save state
        updateSaveButton();

        // Set follow button
        if (currentPostData.isSelf) {
            modalFollowBtn.style.display = 'none';
        } else {
            modalFollowBtn.style.display = 'inline-block';
            modalFollowBtn.href = `/follow-create/${currentPostData.userId}/?next=${window.location.pathname}`;
            if (currentPostData.isFollowed) {
                modalFollowBtn.textContent = 'Following';
                modalFollowBtn.classList.add('following');
            } else {
                modalFollowBtn.textContent = 'Follow';
                modalFollowBtn.classList.remove('following');
            }
        }

        // Set post ID for comment form
        modalPostId.value = currentPostData.id;

        // Set time (you can make this dynamic)
        modalTime.textContent = '2 hours ago';

        // Load comments
        loadComments(currentPostData.id);

        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function updateModalStats() {
        const modalStats = document.getElementById('modalStats');
        let statsText = `${currentPostData.likes} likes`;

        if (currentPostData.type === 'reel') {
            statsText += ` • ${currentPostData.views || currentPostData.likes} views`;
        } else {
            statsText += ` • ${currentPostData.comments} comments`;
        }
        modalStats.textContent = statsText;
    }

    function updateLikeButton() {
        const modalLikeBtn = document.getElementById('modalLikeBtn');
        const likeIcon = modalLikeBtn.querySelector('i');

        if (currentPostData.likedByUser) {
            modalLikeBtn.classList.add('liked');
            likeIcon.className = 'fas fa-heart';
        } else {
            modalLikeBtn.classList.remove('liked');
            likeIcon.className = 'far fa-heart';
        }
    }

    function updateSaveButton() {
        const modalSaveBtn = document.getElementById('modalSaveBtn');
        const saveIcon = modalSaveBtn.querySelector('i');

        if (currentPostData.savedByUser) {
            modalSaveBtn.classList.add('saved');
            saveIcon.className = 'fas fa-bookmark';
        } else {
            modalSaveBtn.classList.remove('saved');
            saveIcon.className = 'far fa-bookmark';
        }
    }

    function startReply(commentId, username) {
        const commentInput = document.getElementById('commentInput');
        const replyInput = document.getElementById('replyInput');
        const parentCommentId = document.getElementById('parentCommentId');
        const cancelReplyBtn = document.getElementById('cancelReplyBtn');

        isReplyMode = true;

        // Hide comment input, show reply input
        commentInput.style.display = 'none';
        replyInput.style.display = 'block';
        cancelReplyBtn.style.display = 'inline-block';

        // Set reply placeholder and focus
        replyInput.placeholder = `Reply to ${username}...`;
        replyInput.value = `@${username} `;
        replyInput.focus();

        // Set parent comment ID
        parentCommentId.value = commentId;

        updateSubmitButton();
    }

    function cancelReply() {
        const commentInput = document.getElementById('commentInput');
        const replyInput = document.getElementById('replyInput');
        const parentCommentId = document.getElementById('parentCommentId');
        const cancelReplyBtn = document.getElementById('cancelReplyBtn');

        isReplyMode = false;

        // Show comment input, hide reply input
        commentInput.style.display = 'block';
        replyInput.style.display = 'none';
        cancelReplyBtn.style.display = 'none';

        // Clear values
        replyInput.value = '';
        parentCommentId.value = '';

        updateSubmitButton();
    }

    function submitComment() {
        const commentInput = document.getElementById('commentInput');
        const replyInput = document.getElementById('replyInput');
        const parentCommentId = document.getElementById('parentCommentId');
        const postId = document.getElementById('modalPostId').value;

        const activeInput = isReplyMode ? replyInput : commentInput;
        const text = activeInput.value.trim();

        if (!text) return;

        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('post_id', postId);

        if (isReplyMode) {
            formData.append('reply_comment', text);
            formData.append('parent_comment_id', parentCommentId.value);
        } else {
            formData.append('comment', text);
        }

        fetch('/explore/', { // Assuming this endpoint handles comment/reply submission
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                // Clear input
                activeInput.value = '';
                updateSubmitButton();

                // Cancel reply mode if active
                if (isReplyMode) {
                    cancelReply();
                }

                // Update the postsData with the new comment/reply
                // This is a simplified approach; for production, you might want the server to return the new comment/reply object
                // and then append it to postsData and re-render only the new comment/reply.
                // For now, we'll just increment the count and reload comments to reflect changes.
                if (!isReplyMode) { // Only increment post comment count for top-level comments
                    currentPostData.comments++;
                    updateModalStats();
                }
                loadComments(postId); // Reload comments to show the new one and update counts
            }
        })
        .catch(error => {
            console.error('Error submitting comment:', error);
        });
    }

    function toggleModalLike() {
        const postId = currentPostData.id;

        fetch(`/like/${postId}/`, {
            method: 'GET', // Assuming Django view expects GET for post likes
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentPostData.likedByUser = data.liked;
                currentPostData.likes = data.likes_count;

                updateLikeButton();
                updateModalStats();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function toggleModalSave() {
        const postId = currentPostData.id;

        fetch(`/saved/${postId}/`, {
            method: 'GET', // Assuming Django view expects GET for saving posts
        })
        .then(() => {
            currentPostData.savedByUser = !currentPostData.savedByUser;
            updateSaveButton();
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function toggleCommentLike(commentId) {
        const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
        if (!commentElement) {
            console.error('Comment element not found for ID:', commentId);
            return;
        }

        const heartButton = commentElement.querySelector('.comment-heart');
        const likesSpan = commentElement.querySelector('.comment-likes');
        let isCurrentlyLiked = heartButton.classList.contains('liked');
        let currentLikes = parseInt(likesSpan.textContent.split(' ')[0]);
        const action = isCurrentlyLiked ? 'unlike' : 'like';

        // Optimistic UI update
        if (isCurrentlyLiked) {
            heartButton.classList.remove('liked');
            heartButton.querySelector('i').className = 'far fa-heart';
            likesSpan.textContent = `${currentLikes - 1} likes`;
        } else {
            heartButton.classList.add('liked');
            heartButton.querySelector('i').className = 'fas fa-heart';
            likesSpan.textContent = `${currentLikes + 1} likes`;
        }

        // Update postsData in memory optimistically
        const postData = postsData[currentPostData.id];
        if (postData) {
            const comment = postData.comments.find(c => c.id == commentId);
            if (comment) {
                comment.likedByUser = !isCurrentlyLiked;
                comment.likesCount = isCurrentlyLiked ? currentLikes - 1 : currentLikes + 1;
            }
        }

        console.log(`Attempting to ${action} comment ${commentId} via GET...`);

        // Send GET request to Django backend
        fetch(`/comment/${commentId}/?action=${action}&post_id=${currentPostData.id}`, {
            method: 'GET', // Changed to GET
            headers: {
                'X-Requested-With': 'XMLHttpRequest', // Keep this header if Django uses it for AJAX detection
            }
        })
        .then(response => {
            console.log('Comment like GET response status:', response.status);
            // Django view redirects, so we don't expect JSON here.
            // The optimistic update already handled the UI.
        })
        .catch(error => {
            console.error('Error liking/unliking comment:', error);
            // Revert optimistic update if there's a network error
            if (isCurrentlyLiked) { // If it was liked, and we tried to unlike, but failed
                heartButton.classList.add('liked');
                heartButton.querySelector('i').className = 'fas fa-heart';
                likesSpan.textContent = `${currentLikes} likes`;
            } else { // If it was unliked, and we tried to like, but failed
                heartButton.classList.remove('liked');
                heartButton.querySelector('i').className = 'far fa-heart';
                likesSpan.textContent = `${currentLikes} likes`;
            }
            // Revert postsData in memory
            if (postData) {
                const comment = postData.comments.find(c => c.id == commentId);
                if (comment) {
                    comment.likedByUser = isCurrentlyLiked;
                    comment.likesCount = currentLikes;
                }
            }
        });
    }

    function toggleReplyLike(replyId) {
        const replyElement = document.querySelector(`[data-reply-id="${replyId}"]`);
        if (!replyElement) {
            console.error('Reply element not found for ID:', replyId);
            return;
        }

        const heartButton = replyElement.querySelector('.comment-heart');
        const likesSpan = replyElement.querySelector('.comment-likes');
        let isCurrentlyLiked = heartButton.classList.contains('liked');
        let currentLikes = parseInt(likesSpan.textContent.split(' ')[0]);
        const action = isCurrentlyLiked ? 'unlike' : 'like';

        // Optimistic UI update
        if (isCurrentlyLiked) {
            heartButton.classList.remove('liked');
            heartButton.querySelector('i').className = 'far fa-heart';
            likesSpan.textContent = `${currentLikes - 1} likes`;
        } else {
            heartButton.classList.add('liked');
            heartButton.querySelector('i').className = 'fas fa-heart';
            likesSpan.textContent = `${currentLikes + 1} likes`;
        }

        // Update postsData in memory optimistically
        const postData = postsData[currentPostData.id];
        if (postData) {
            postData.comments.forEach(comment => {
                const reply = comment.replies.find(r => r.id == replyId);
                if (reply) {
                    reply.likedByUser = !isCurrentlyLiked;
                    reply.likesCount = isCurrentlyLiked ? currentLikes - 1 : currentLikes + 1;
                }
            });
        }

        console.log(`Attempting to ${action} reply ${replyId} via GET...`);

        // Send GET request to Django backend
        fetch(`/reply_comment/${replyId}/?action=${action}&post_id=${currentPostData.id}`, {
            method: 'GET', // Changed to GET
            headers: {
                'X-Requested-With': 'XMLHttpRequest', // Keep this header if Django uses it for AJAX detection
            }
        })
        .then(response => {
            console.log('Reply like GET response status:', response.status);
            // Django view redirects, so we don't expect JSON here.
            // The optimistic update already handled the UI.
        })
        .catch(error => {
            console.error('Error liking/unliking reply:', error);
            // Revert optimistic update if there's a network error
            if (isCurrentlyLiked) {
                heartButton.classList.add('liked');
                heartButton.querySelector('i').className = 'fas fa-heart';
                likesSpan.textContent = `${currentLikes} likes`;
            } else {
                heartButton.classList.remove('liked');
                heartButton.querySelector('i').className = 'far fa-heart';
                likesSpan.textContent = `${currentLikes} likes`;
            }
            // Revert postsData in memory
            if (postData) {
                postData.comments.forEach(comment => {
                    const reply = comment.replies.find(r => r.id == replyId);
                    if (reply) {
                        reply.likedByUser = isCurrentlyLiked;
                        reply.likesCount = currentLikes;
                    }
                });
            }
        });
    }

    function closeModal() {
        const modal = document.getElementById('postModal');
        const modalVideo = document.getElementById('modalVideo');
        const commentInput = document.getElementById('commentInput');
        const commentSubmitBtn = document.getElementById('commentSubmitBtn');

        modal.classList.remove('active');
        document.body.style.overflow = 'auto';

        // Pause video if playing
        if (modalVideo.style.display === 'block') {
            modalVideo.pause();
        }

        // Clear inputs and reset state
        if (commentInput) {
            commentInput.value = '';
            commentSubmitBtn.classList.remove('active');
        }

        // Cancel reply mode
        if (isReplyMode) {
            cancelReply();
        }

        currentPostData = null;
    }

    function focusCommentInput() {
        const commentInput = document.getElementById('commentInput');
        if (commentInput) {
            commentInput.focus();
        }
    }

    // Close modal when clicking outside
    document.getElementById('postModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
      const modal = document.getElementById("editProfileModal");
      const btn = document.getElementById("edit-profile-btn");
      const closeBtn = document.getElementById("closeEditProfile");

      // Always reset modal to hidden on load
      modal.style.display = "none";

      btn.addEventListener("click", () => {
          modal.style.display = "block";
      });

      closeBtn.addEventListener("click", () => {
          modal.style.display = "none";
      });

      window.addEventListener("click", (event) => {
          if (event.target === modal) {
              modal.style.display = "none";
          }
      });
  });


</script>
{% endblock %}
